pipeline {
    agent any
    
    triggers {
        pollSCM('H/5 * * * *')
    }

    environment {
        // On définit le dossier où se trouvent compose.yaml et .env
        COMPOSE_DIR = "Poc/Poc/src/main/resources"
    }

    stages {
        stage('Nettoyage & Préparation') {
            steps {
                echo 'Démarrage des services avec injection automatique du fichier .env...'
                // Docker Compose charge  le .env 
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml stop app db sonarqube"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml rm -f app db sonarqube"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml up -d db app sonarqube"
            }
        }

        stage('Analyse SonarQube') {
            steps {
                echo 'Attente du démarrage de SonarQube...'
                sleep 40
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm sonar-scanner"
            }
        }

        stage('Tests API (Newman)') {
            steps {
                echo 'Lancement des tests Newman...'
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm newman-db-cleaner"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm newman"
            }
        }

        stage('Tests E2E') {
            steps {
                echo 'Lancement des scénarios Selenium...'
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm e2e-tests-reservation1"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm e2e-tests-reservation2"
            }
        }
    }

    post {
        always {
            echo 'Nettoyage final...'
            sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml stop app db"
        }
    }
}