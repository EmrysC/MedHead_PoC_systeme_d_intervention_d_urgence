pipeline {
    agent any
    
    triggers {
        pollSCM('H/5 * * * *')
    }

    environment {
        COMPOSE_DIR = "Poc/Poc/src/main/resources"
    }

    stages {

        stage('Initialisation Workspace') {
            steps {
                echo 'Injection des secrets depuis le volume Jenkins...'
                // On récupère le fichier monté dans le conteneur Jenkins vers le répertoire de build
                sh "cp /var/jenkins_home/.env ${COMPOSE_DIR}/.env"
            }
        }

        stage('Nettoyage & Préparation') {
            steps {
                echo 'Redémarrage des services applicatifs...'
                // On ne stoppe que l'app et la db pour garder SonarQube "chaud" (plus rapide)
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml stop app db"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml rm -f app db"
                // up -d s'assure que tout tourne sans réinitialiser Sonar s'il est déjà là
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml up -d db app sonarqube"
            }
        }

        stage('Compilation') {
            steps {
                echo 'Compilation du projet avec le Maven de Jenkins...'
                // On se déplace dans le dossier contenant le fichier pom.xml (Poc/Poc)
                dir("Poc/Poc") {
                    sh "mvn clean compile"
                }
            }
        }

        stage('Lancement Application') {
            steps {
                echo 'Démarrage de l application en arrière-plan pour les tests...'
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml up -d app"
            }
        }

        stage('Analyse SonarQube') {
            steps {
                echo 'Attente de stabilisation (30s)...'
                sleep 30
                echo 'Lancement du scan...'
                sh """
                    docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm \
                    sonar-scanner \
                    -Dsonar.projectKey=MedHead_PoC \
                    -Dsonar.projectName=MedHead_PoC_System \
                    -Dsonar.host.url=http://sonarqube-poc:9000 \
                    -Dsonar.login=admin \
                    -Dsonar.password=admin \
                    -Dsonar.sources=. \
                    -Dsonar.java.binaries=. \
                    -Dsonar.exclusions=**/target/**,**/*.env
                """
            }
        }

        stage('Tests API (Newman)') {
            steps {
                echo 'Nettoyage DB et lancement Newman...'
                // On récupère le chemin absolu du dossier de tests
                script {
                    def newman_abs_path = sh(script: "pwd", returnStdout: true).trim() + "/${COMPOSE_DIR}/api_tests_newman"
                    
                    // On lance le cleaner en forçant le montage du volume (-v) avec le chemin absolu
                    sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm -v ${newman_abs_path}:/scripts newman-db-cleaner"
                    
                    // On lance Newman de la même manière
                    sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm -v ${newman_abs_path}:/etc/newman newman"
                }
            }
        }

        stage('Tests E2E') {
            steps {
                echo 'Lancement des scénarios Selenium...'
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm e2e-reservation"
                sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml run --rm e2e-autre-test"
            }
        }
    }

    post {
        always {
            echo 'Nettoyage final...'
            // 1. On stoppe d'abord (Docker a besoin du .env pour identifier les services)
            sh "docker-compose -f ${COMPOSE_DIR}/compose.yaml stop app db"
            // 2. On supprime le secret ensuite
            sh "rm -f ${COMPOSE_DIR}/.env"
        }
    }
}