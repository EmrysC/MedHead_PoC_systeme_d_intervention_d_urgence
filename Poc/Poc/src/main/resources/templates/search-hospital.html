<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedHead - Recherche Trajet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        :root { 
            --mh-primary: #0d6efd; 
            --mh-bg: #fff; 
            --mh-card-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        body { 
            background-color: var(--mh-bg); 
            font-family: 'Inter', sans-serif; 
            color: #2d3436;
        }

        [v-cloak] { display: none; }

        .page-header { margin-bottom: 2rem; }
        .back-link { text-decoration: none; color: #adb5bd; transition: color 0.2s; }
        .back-link:hover { color: var(--mh-primary); }

        /* Carte d'information (Spécialité) */
        .info-banner {
            background-color: #e7f1ff;
            border: none;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            color: #084298;
        }

        /* Barre de recherche */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .search-input {
            border-radius: 12px;
            padding-left: 2.8rem;
            border: 1px solid #e0e0e0;
            box-shadow: var(--mh-card-shadow);
            height: 50px;
        }
        .search-icon {
            position: absolute;
            left: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
        }

        /*  Hôpitaux  */
        .hospital-card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: var(--mh-card-shadow);
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
            border-left: 4px solid transparent;
        }
        .hospital-card:hover { 
            transform: translateY(-2px);
            border-left: 4px solid var(--mh-primary);
        }

        .badge-beds { 
            font-weight: 700;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
        }

        .btn-action {
            border-radius: 10px;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
        }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <main class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">
                
                <div class="page-header d-flex align-items-center">
                    <a href="javascript:history.back()" class="back-link me-3">
                        <i class="bi bi-arrow-left-circle-fill fs-2"></i>
                    </a>
                    <div>
                        <h2 class="fw-bold mb-0">Trouver un hôpital</h2>
                        <p class="text-muted mb-0">Localisez les lits disponibles à proximité.</p>
                    </div>
                </div>

                <div class="info-banner">
                    <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                    <div>
                        <small class="d-block text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 0.5px;">Urgence identifiée</small>
                        <span class="fw-bold">{{ specialisationNom }}</span>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-3 mb-4" style="border-radius: 15px;">
                    <div class="row g-2">
                        <div class="col-md-8">
                            <!-- Barre de recherche de l'adresse-->
                            <div class="search-container mb-0">
                                <i class="bi bi-geo-alt-fill search-icon"></i>
                                <input type="text" v-model="addressQuery" 
                                       class="form-control search-input" 
                                       placeholder="Entrez une adresse de départ..."
                                       @keyup.enter="fetchByAddress">
                            </div>
                        </div>
                        <!-- Bouton pour chercher-->
                        <div class="col-md-2 col-6">
                            <button @click="fetchByAddress" class="btn btn-primary w-100 btn-action h-100" :disabled="loading">
                                <span v-if="loading" class="spinner-border spinner-border-sm"></span>
                                <span v-else>Chercher</span>
                            </button>
                        </div>
                        <!-- Bouton du GPS-->
                        <div class="col-md-2 col-6">
                            <button @click="fetchByGPS" class="btn btn-outline-primary w-100 btn-action h-100" :disabled="loading">
                                <i class="bi bi-crosshair"></i> GPS
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="loading" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                    <p class="text-muted fw-medium">Calcul des meilleurs itinéraires...</p>
                </div>

                <div v-if="results.length > 0">
                    <div v-for="h in results" :key="h.idUniteSoins" class="card hospital-card">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1 text-dark">{{ h.nomHopital }}</h5>
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-geo-alt me-1"></i> {{ h.destinationCalculee.destinationAdresse }}
                                    </p>
                                </div>
                                <span class="badge bg-success-subtle text-success badge-beds border border-success-subtle">
                                    {{ h.litsDisponibles }} lits libres
                                </span>
                            </div>

                            <div class="row g-0 border-top pt-3 mt-3">
                                <div class="col-6 border-end">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="bi bi-signpost-2 text-primary fs-4 me-2"></i>
                                        <div>
                                            <small class="d-block text-muted">Distance</small>
                                            <span class="fw-bold">{{ formatDistance(h.destinationCalculee.distanceMetres) }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="bi bi-clock-history text-primary fs-4 me-2"></i>
                                        <div>
                                            <small class="d-block text-muted">Temps estimé</small>
                                            <span class="fw-bold">{{ formatTime(h.destinationCalculee.dureeMinutes) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else-if="!loading && searched" class="text-center py-5 bg-light rounded-4 border">
                    <i class="bi bi-exclamation-triangle fs-1 text-muted"></i>
                    <p class="text-muted mt-2">Aucun lit disponible trouvé à proximité.</p>
                </div>

            </div>
        </div>
    </main>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
        setup() {
            const specialisationId = ref(null);
            const specialisationNom = ref('');
            const addressQuery = ref('');
            const results = ref([]);
            const loading = ref(false);
            const searched = ref(false);

            onMounted(() => {
                const params = new URLSearchParams(window.location.search);
                specialisationId.value = params.get('id');
                specialisationNom.value = params.get('nom') || 'Spécialité inconnue';
            });

            const formatDistance = (m) => m ? (m / 1000).toFixed(1) + ' km' : "N/A";
            
            const formatTime = (totalSeconds) => {
    if (!totalSeconds) return "N/A";

    // si on est a plus d une heure
    const totalMinutes = Math.floor(totalSeconds / 60);
    const seconds = Math.floor(totalSeconds % 60);
    if (totalMinutes >= 60) {
        const h = Math.floor(totalMinutes / 60);
        const m = totalMinutes % 60;
        return `${h}h ${m}min`;
    }

    return `${totalMinutes} min ${seconds}s`;
};

            const callAPI = async (extraParams) => {
                loading.value = true;
                searched.value = true;
                results.value = [];
                const token = localStorage.getItem('token');
                
                try {
                    const queryParams = new URLSearchParams({
                        specialisationId: specialisationId.value,
                        ...extraParams
                    });

                    const response = await fetch(`/api/unitesoins/trajets?${queryParams}`, {
                        method: 'GET',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.trajetsCalculesValide?.originePosition?.positionValid) {
                            addressQuery.value = data.trajetsCalculesValide.originePosition.positionValid;
                        }
                        if (data.trajetsCalculesValide?.unitesSoinsTrajets) {
                            results.value = data.trajetsCalculesValide.unitesSoinsTrajets;
                        }
                    } else {
                        alert("Erreur lors de la recherche.");
                    }
                } catch (error) {
                    console.error("Erreur réseau", error);
                } finally {
                    loading.value = false;
                }
            };

            const fetchByAddress = () => {
                if (!addressQuery.value.trim()) return;
                callAPI({ adresse: addressQuery.value });
            };

            const fetchByGPS = () => {
                if (!navigator.geolocation) return;
                loading.value = true;
                navigator.geolocation.getCurrentPosition((pos) => {
                    callAPI({ latitude: pos.coords.latitude, longitude: pos.coords.longitude });
                }, () => { loading.value = false; });
            };

            return { specialisationNom, addressQuery, results, loading, searched, fetchByAddress, fetchByGPS, formatDistance, formatTime };
        }
    }).mount('#app');
</script>
</body>
</html>